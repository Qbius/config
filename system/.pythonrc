import os
import sys

HOME = os.path.normpath(os.environ['HOME'])
PYTHONRC_CACHE = os.path.join(HOME, '.pythonrc_cache')
PYTHONRC_STATES = os.path.join(PYTHONRC_CACHE, 'states')
PYTHONRC_SESSIONS = os.path.join(PYTHONRC_CACHE, 'sessions')

if not os.path.exists(PYTHONRC_CACHE): os.mkdir(PYTHONRC_CACHE)
if not os.path.exists(PYTHONRC_STATES): os.mkdir(PYTHONRC_STATES)
if not os.path.exists(PYTHONRC_SESSIONS): os.mkdir(PYTHONRC_SESSIONS)

def save_state(what, pcid, path = PYTHONRC_STATES):
    with open(os.path.join(path, f'{pcid}.state'), 'wb') as where:
        from dill import dump
        dump(what, where, recurse = True)

def load_state(pcid, path = PYTHONRC_STATES):
    with open(os.path.join(path, f'{pcid}.state'), 'rb') as where:
        from dill import load
        return load(where)

if not os.path.exists(os.path.join(PYTHONRC_CACHE, 'vars.state')): save_state(dict(), 'vars', PYTHONRC_CACHE)

def save_session(sessid, path = PYTHONRC_SESSIONS):
    from dill import dump_session
    dump_session(os.path.join(path, f'{sessid}.session'))
    
def load_session(sessid, path = PYTHONRC_SESSIONS):
    from dill import load_session
    load_session(os.path.join(path, f'{sessid}.session'))

def pause():
    save_session('saved', PYTHONRC_CACHE)
    exit()

def persist(*args, name = None):
    onearg = len(args) == 1
    if (not onearg and name != None) or (len(args) > 0 and name):
        raise TypeError(f"persist() takes 1 argument but {len(args) + int(bool(name))} were given")
        
    global built_ins
    current_state = load_state('vars', PYTHONRC_CACHE)

    var = args[0] if onearg else name
    searched_val = lambda varname, value: varname not in built_ins and value is var if onearg else varname is name
    vars = {k: v for k, v in globals().items() if searched_val(k, v)}

    if len(vars.items()) > 1:
        print(f"More than one variable has that value: {', '.join(vars.keys())}.")
        print(f"Consider stating the variable's name explicitly, like so: persist(name = '{list(vars.keys())[0]}').")
    elif len(vars.items()) == 0:
        print("No variables matching the given criteria")
    else:
        save_state({**current_state, **vars}, 'vars', PYTHONRC_CACHE)

def forget(*args, name = None):
    onearg = len(args) == 1
    if (not onearg and name != None) or (len(args) > 0 and name):
        raise TypeError(f"forget() takes 1 argument but {len(args) + int(bool(name))} were given")
        
    global built_ins
    current_state = load_state('vars', PYTHONRC_CACHE)

    var = args[0] if onearg else name
    searched_val = lambda varname, value: varname not in built_ins and value is var if onearg else varname is name
    vars = {k: v for k, v in current_state.items() if searched_val(k, v)}

    if len(vars.items()) > 1:
        print(f"More than one saved variable has that value: {', '.join(vars.keys())}.")
        print(f"Consider stating the variable's name explicitly, like so: forget(name = '{list(vars.keys())[0]}').")
    elif len(vars.items()) == 0:
        print("No variables matching the given criteria")
    else:
        k, v = vars.popitem()
        current_state.pop(k, None)
        save_state(current_state, 'vars', PYTHONRC_CACHE)

built_ins = list(globals().keys())
for name, value in load_state('vars', PYTHONRC_CACHE).items():
    globals()[name] = value

if os.path.exists(os.path.join(PYTHONRC_CACHE, 'saved.session')):
    load_session('saved', PYTHONRC_CACHE)
    os.remove(os.path.join(PYTHONRC_CACHE, 'saved.session'))